{% extends 'tedx_finance/base.html' %}
{% block title %}Notifications{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-900 py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-4">
                    <div class="bg-blue-500/20 p-4 rounded-xl">
                        <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-4xl font-black text-white">Notifications</h1>
                        <p class="text-slate-400 text-sm mt-1">
                            <span class="text-blue-400 font-bold">{{ unread_count }}</span>
                            unread · 
                            <span class="text-slate-400">{{ total_notifications }} total</span>
                        </p>
                    </div>
                </div>
                
                <!-- Mark All Read Button -->
                {% if unread_count > 0 %}
                <button onclick="markAllNotificationsRead()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                    Mark All Read
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Notifications List -->
        <div class="space-y-3">
            {% if notifications %}
                {% for notification in notifications %}
                    <div class="notification-card relative overflow-hidden rounded-xl border transition-all {% if not notification.is_read %}bg-slate-800/80 border-blue-500/30 shadow-lg shadow-blue-500/10{% else %}bg-slate-800/40 border-slate-700 opacity-75{% endif %} p-5 group hover:scale-102 hover:shadow-lg" 
                         id="notification-{{ notification.id }}"
                         data-unread="{% if notification.is_read %}false{% else %}true{% endif %}">
                        
                        <!-- Background gradient -->
                        <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(34, 197, 238, 0.05))"></div>
                        
                        <div class="relative z-10 flex items-start gap-4">
                            <!-- Icon based on notification type -->
                            <div class="flex-shrink-0 mt-1">
                                {% if notification.notification_type == 'transaction_approved' %}
                                    <div class="bg-green-500/20 p-3 rounded-lg">
                                        <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                {% elif notification.notification_type == 'transaction_rejected' %}
                                    <div class="bg-red-500/20 p-3 rounded-lg">
                                        <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l-2-2m0 0l-2-2m2 2l2-2m-2 2l-2 2"/>
                                        </svg>
                                    </div>
                                {% elif notification.notification_type == 'fund_created' %}
                                    <div class="bg-emerald-500/20 p-3 rounded-lg">
                                        <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                {% elif notification.notification_type == 'budget_exceeded' %}
                                    <div class="bg-orange-500/20 p-3 rounded-lg">
                                        <svg class="w-6 h-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                        </svg>
                                    </div>
                                {% else %}
                                    <div class="bg-indigo-500/20 p-3 rounded-lg">
                                        <svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Content -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-start justify-between gap-4 mb-1">
                                    <h3 class="text-white font-bold text-base">{{ notification.title }}</h3>
                                    {% if not notification.is_read %}
                                    <span class="inline-block bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded whitespace-nowrap">NEW</span>
                                    {% endif %}
                                </div>
                                
                                <p class="text-slate-300 text-sm mb-3">{{ notification.message }}</p>
                                
                                <div class="flex items-center justify-between">
                                    <time class="text-xs text-slate-500" title="{{ notification.created_at }}">
                                        {{ notification.created_at|timesince }} ago
                                    </time>
                                    
                                    {% if not notification.is_read %}
                                    <button onclick="markNotificationRead({{ notification.id }})" 
                                            class="text-blue-400 hover:text-blue-300 text-sm font-semibold transition-colors">
                                        Mark as read
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-12">
                    <svg class="w-16 h-16 text-slate-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                    </svg>
                    <h3 class="text-slate-300 font-bold text-lg mb-1">No Notifications</h3>
                    <p class="text-slate-500">You're all caught up! Check back later for updates on your transactions.</p>
                </div>
            {% endif %}
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <nav class="mt-8 flex justify-center gap-2">
            {% if page_obj.has_previous %}
                <a href="?page=1" class="bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-2 rounded text-sm">First</a>
                <a href="?page={{ page_obj.previous_page_number }}" class="bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-2 rounded text-sm">← Previous</a>
            {% endif %}
            
            <div class="flex items-center gap-2">
                <span class="text-slate-400 text-sm">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            </div>
            
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}" class="bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-2 rounded text-sm">Next →</a>
                <a href="?page={{ page_obj.paginator.num_pages }}" class="bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-2 rounded text-sm">Last</a>
            {% endif %}
        </nav>
        {% endif %}
    </div>
</div>

<script>
function markNotificationRead(notificationId) {
    fetch(`/notifications/${notificationId}/mark-read/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove NEW badge and update styling
            const notifCard = document.getElementById(`notification-${notificationId}`);
            if (notifCard) {
                notifCard.classList.remove('bg-slate-800/80', 'border-blue-500/30', 'shadow-lg', 'shadow-blue-500/10');
                notifCard.classList.add('bg-slate-800/40', 'border-slate-700', 'opacity-75');
                
                // Remove mark as read button
                const markBtn = notifCard.querySelector('button');
                if (markBtn) markBtn.remove();
            }
            
            // Update unread count in header and navbar if they exist
            updateUnreadBadge(data.unread_count);
        }
    })
    .catch(error => console.error('Error:', error));
}

function markAllNotificationsRead() {
    if (!confirm('Mark all notifications as read?')) return;
    
    fetch('/notifications/mark-all-read/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to reflect changes
            location.reload();
        }
    })
    .catch(error => console.error('Error:', error));
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function updateUnreadBadge(count) {
    const badge = document.getElementById('unread-count-badge');
    if (badge) {
        if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }
    }
}

// Poll for new notifications every 30 seconds
setInterval(() => {
    fetch('/notifications/api/unread/')
        .then(response => response.json())
        .then(data => {
            updateUnreadBadge(data.unread_count);
        })
        .catch(error => console.error('Error polling notifications:', error));
}, 30000);
</script>

<style>
    @keyframes scale-102 {
        from { transform: scale(1); }
        to { transform: scale(1.02); }
    }
    
    .hover\:scale-102:hover {
        animation: scale-102 0.2s ease-out forwards;
    }
</style>
{% endblock %}
